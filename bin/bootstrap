#!/bin/bash

set -ehu

pwd=$PWD
user=$USER
term=$TERM
home=$HOME

unset `env | awk -F= '/^\w/ {print $1}' | xargs`

# Exports
export HOME=$home
export PWD=$pwd
export USER=$user
export TERM=$term
export LC_ALL="POSIX"
export PATH=$HOME/bin:/opt/tools/bin:/bin:/bin:/usr/bin
export MAKEFLAGS="-j4 -s -e -w"
TARGET="arm-linux-gnueabi"
PREFIX="/opt/tools/"
BOOTSTRAP=$PWD

SRC="$BOOTSTRAP/src"
BLD="$BOOTSTRAP/bld"
TAR="$BOOTSTRAP/tar"
PRG="$BOOTSTRAP/prg"

COMMON_FLAGS="--target=$TARGET \
	--disable-nls \
	--with-sysroot \
	--disable-threads \
	--disable-multilib \
	--config-cache"

is_done() {
	if [[ -f $PRG/$1.done ]]; then
		echo $1 done skipping.
		return 0;
	else
		return 1;
	fi
}

mk_build_dir() {
	[[ -d $BLD/$1 ]] && return 0
	mkdir "$BLD/$1"
}

stage() {
	d="$1-$2"
	[[ -d $SRC/$d ]] && return 0
	echo staging $1-$2
	tar xf $TAR/$d.$3 -C "$SRC"
	return 0
}

cross_binutils() {
	local n="binutils"
	local v="2.22"
	local e="tar.gz"
	local flags="--enable-shared --prefix=$PREFIX"

	is_done $FUNCNAME && return 0

	stage $n $v $e 
	mk_build_dir $FUNCNAME

	# build
	pushd $BLD/$FUNCNAME
		$SRC/$n-$v/configure $COMMON_FLAGS $flags
		make configure-host
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

cross_gcc() {
	local n="gcc"
	local v="4.7.1"
	local e="tar.bz2"
	local flags="--disable-decimal-float \
		--disable-threads \
		--disable-bootstrap \
		--disable-libmudflap \
		--disable-libssp \
		--disable-shared \
		--disable-libgomp \
		--disable-libquadmath \
		--disable-target-libiberty  \
		--disable-target-zlib \
		--without-headers \
		--without-ppl \
		--without-cloog \
		--with-newlib \
		--prefix=$PREFIX \
		--enable-languages=c"


	is_done $FUNCNAME && return 0

	stage $n $v $e 
	mk_build_dir $FUNCNAME
	#local linuxh="$SRC/$n-$v/gcc/config/linux.h"

	# build
	pushd $BLD/$FUNCNAME
		$SRC/$n-$v/configure $COMMON_FLAGS $flags
		make all-gcc all-target-libgcc
		make install-gcc install-target-libgcc
		touch "$PRG/$FUNCNAME.done"
	popd
}

api_headers() {
	local n="linux"
	local v="3.3"
	local e="tar.xz"

	is_done $FUNCNAME && return 0

	stage $n $v $e

	# build
	pushd $SRC/$n-$v
		make mrproper
		make ARCH=arm headers_check
		make ARCH=arm INSTALL_HDR_PATH=/cross headers_install

		touch "$PRG/$FUNCNAME.done"
	popd
}

libc() {
	export MAKEFLAGS="-j4 -s -w"
	local n="eglibc"
	local v="2.13"
	local r="r13356"
	local e="tar.bz2"
	local flags="--host=$TARGET \
		--disable-profile \
		--enable-add-ons \
		--with-__thread \
		--enable-kernel=2.6.22.5 \
		--with-tls \
		--prefix=/cross \
		--with-headers=/cross/include \
		--disable-sanity-checks"

	is_done $FUNCNAME && return 0

	if [[ ! -d $SRC/$n-$v ]]; then
		stage $n $v-$r $e
		stage $n-ports $v-$r  $e
		cp -a "$SRC/ports" "$SRC/$n-$v/ports"
		sed -e 's/-lgcc_eh//g' -i "$SRC/$n-$v/Makeconfig"
	fi

	mk_build_dir $FUNCNAME
	# build
	pushd $BLD/$FUNCNAME
		"$SRC/$n-$v/configure" $COMMON_FLAGS $flags
		make install-headers || true
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd

}

cross_gcc_final() {
	local n="gcc"
	local v="4.7.1"
	local e="tar.bz2"
	local flags="--enable-languages=c \
		--enable-shared \
		--enable-threads=posix"

	is_done $FUNCNAME && return 0

	stage $n $v $e 
	mk_build_dir $FUNCNAME
	#local linuxh="$SRC/$n-$v/gcc/config/linux.h"

	# build
	pushd $BLD/$FUNCNAME
		$SRC/$n-$v/configure $COMMON_FLAGS $flags
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

cross_binutils
cross_gcc
api_headers
libc
#cross_gcc_final

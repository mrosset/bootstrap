#!/bin/bash

set -ehu

xpwd=$PWD
user=$USER
term=$TERM
home=$HOME

unset `env | awk -F= '/^\w/ {print $1}' | xargs`

# enviroment
export HOME=$home
export PWD=$xpwd
export USER=$user
export TERM=$term
export LC_ALL="POSIX"
export PATH=$HOME/bin:/opt/tools/bin:/bin:/usr/bin

# toolchain tweaks
export CFLAGS="-O2 -pipe"
export MAKEFLAGS="-j4 -sw"
export LIBTOOLFLAGS="--silent"

#TARGET="x86_64-linux-uclibc"
#TARGET="arm-unknown-linux-gnueabi"
#TARGET="i686-linux-gnu"
PREFIX="/opt/tools/"

# Dirs
BOOTSTRAP=$PWD
SRC="$BOOTSTRAP/src"
BLD="$BOOTSTRAP/bld"
TAR="$BOOTSTRAP/tar"
PRG="$BOOTSTRAP/prg"

COMMON_FLAGS="--prefix=$PREFIX \
	--disable-nls \
	--disable-multilib \
	--disable-bootstrap \
	--enable-threads \
	--disable-werror \
	--enable-static \
	--disable-shared \
	--config-cache \
	-q"

# Mirrors
GNU_MIRROR="http://mirrors.kernel.org/gnu"

is_done() {
	if [[ -f $PRG/$1.done ]]; then
		echo $1 done skipping.
		return 0;
	else
		return 1;
	fi
}

mk_build_dir() {
	[[ -d $BLD/$1 ]] && return 0
	mkdir "$BLD/$1"
}

stage() {
	[[ -d $SRC/$1 ]] && return 0
	echo staging $1
	tar xf $TAR/$1 -C "$SRC"
	return 0
}

get() {
	[[ -f $TAR/$(basename $1) ]] && return 0
	pushd $TAR
		wget -c $1
	popd
}



GMP_VERSION="gmp-5.1.3"

static_make() {
	local file="$GMP_VERSION.tar.xz"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/${GMP_VERSION%-*}/$file"

	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$GMP_VERSION"/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

MPFR_VERSION="mpfr-3.1.2"

static_mpfr() {
	local file="$MPFR_VERSION.tar.xz"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/${MPFR_VERSION%-*}/$file"

	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$MPFR_VERSION"/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}


for i in $SRC $BLD $TAR $PRG; do
	if [[ ! -d $i ]]; then 
		mkdir -v $i
	fi
done

static_make
static_mpfr


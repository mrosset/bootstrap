#!/bin/bash


set -ehu

xpwd=$PWD
user=$USER
term=$TERM
home=$HOME

unset $(env | awk -F= '/^\w/ {print $1}' | xargs)



# enviroment
export HOME=$home
export PWD=$xpwd
export USER=$user
export TERM=$term
export LC_ALL="POSIX"

BOOTSTRAP="$PWD"

# check we are in the right directory
if [[ ! -f $BOOTSTRAP/bin/bootstrap ]]; then
	echo This needs to be run in boostrap directory eg. bin/bootstrap
	exit 1
fi

# toolchain tweaks
export CFLAGS="-O2 -pipe"
export CPPFLAGS="$CFLAGS"
export MAKEFLAGS="-sw"
export LIBTOOLFLAGS="--silent"

#TARGET="x86_64-linux-uclibc"
TARGET="arm-unknown-linux-gnueabi"
#TARGET="i686-linux-gnu"
PREFIX="$HOME/tools"
SYSROOT="$HOME/system/$TARGET"

export PATH=$HOME/bin:$PREFIX/bin:/bin:/usr/bin

case $TARGET in
	arm*-*)
		ARCH=arm
		MFLAGS=""
		#MFLAGS="--with-march=armv7"
		;;
	x86_64-*)
		ARCH=x86_64
		MFLAGS=""
		;;
	i686-*)
		ARCH=i386
		MFLAGS=""
		;;
	*)
		echo "$TARGET:" unknown arch
		exit 1
		;;
esac

# Dirs
SRC="$BOOTSTRAP/src"
BLD="$BOOTSTRAP/bld"
TAR="$BOOTSTRAP/tar"
PRG="$BOOTSTRAP/prg"

COMMON_FLAGS="--target=$TARGET \
	--prefix=$PREFIX \
	--disable-nls \
	--with-sysroot=$SYSROOT \
	--with-lib-path=$PREFIX/tools \
	--disable-multilib \
	--disable-bootstrap \
	--disable-werror \
	--config-cache \
	$MFLAGS \
	-q"

# Mirrors
GNU_MIRROR="http://mirrors.kernel.org/gnu"

is_done() {
	if [[ -f $PRG/$1.done ]]; then
		echo "$1 done skipping."
		return 0;
	else
		return 1;
	fi
}

mk_build_dir() {
	[[ -d $BLD/$1 ]] && return 0
	mkdir -p "$BLD/$1"
}

stage() {
	local dir="${file%.*.*}"
	[[ -d $SRC/$dir ]] && return 0 
	echo "staging $1"
	tar xf "$TAR/$1" -C "$SRC"
	return 0
}

get() {
	[[ -f $TAR/$(/usr/bin/basename $1) ]] && return 0
	pushd "$TAR"
		/usr/bin/wget -c "$1"
	popd
}

SED_VERSION="4.2.2"

cross_sed() {
	local name="sed"
	local ver="$SED_VERSION"
	local ext="tar.bz2"
	local file="$name-$ver.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure --prefix=$PREFIX -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

cross_texinfo() {
	local n="texinfo"
	local v="4.13a"
	local e="tar.gz"
	local f="$n-$v.$e"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$n/$f"
	stage $n $v $e
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$n-4.13/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

native_compiler() {
	local upstream="http://landley.net/aboriginal/downloads/binaries/root-filesystem/native-compiler-x86_64.tar.bz2"
	local file="$(/usr/bin/basename $upstream)"

	is_done $FUNCNAME && return 0

	get $upstream
	stage $file
	mv "$SRC/${file%.*.*}" .
	touch "$PRG/$FUNCNAME.done"
	#get $upstream
}


MAKE_VERSION="3.82"

cross_make() {
	local name="make"
	local ver="$MAKE_VERSION"
	local ext="tar.gz"
	local file="$name-$ver.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

BINUTILS_VERSION="2.24"

cross_binutils() {
	local name="binutils"
	local ver="$BINUTILS_VERSION"
	local file="$name-$ver.tar.bz2"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage "$file"
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure $COMMON_FLAGS
		make configure-host
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

MPC_VERSION="1.0.2"

cross_mpc() {
	local name="mpc"
	local version="$MPC_VERSION"
	local ext="tar.gz"
	local file="$name-$version.$ext"
	local flags="--with-gmp=$PREFIX"
	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure --prefix=$PREFIX $flags -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

MPFR_VERSION="3.1.2"

cross_mpfr() {
	local name="mpfr"
	local version="$MPFR_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"
	local flags="--with-gmp=$PREFIX"
	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure --prefix=$PREFIX $flags -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

GMP_VERSION="6.0.0a"

cross_gmp() {
	local name="gmp"
	local version="$GMP_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-6.0.0/configure --prefix=$PREFIX -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

GCC_VERSION="4.9.2"

cross_gcc() {
	local name="gcc"
	local version="$GCC_VERSION"
	local ext="tar.bz2"
	local file="$name-$version.$ext"

	local flags="--disable-decimal-float \
		--disable-threads \
		--disable-libmudflap \
		--with-native-system-header-dir=$PREFIX/include \
		--disable-libssp \
		--disable-shared \
		--disable-libgomp \
		--disable-libquadmath \
		--disable-target-libiberty  \
		--disable-target-zlib \
	    --disable-libstdc++-v3 \
		--without-headers \
		--without-ppl \
		--without-cloog \
		--with-newlib \
		--with-gmp=$PREFIX \
		--prefix=$PREFIX \
		--enable-languages=c"


	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$name-$version/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure $COMMON_FLAGS $flags
		make all-gcc all-target-libgcc
		make install-gcc install-target-libgcc
		touch "$PRG/$FUNCNAME.done"
	popd
}

LINUX_VERSION="3.17.2"

linux_headers() {
	local name="linux"
	local version="$LINUX_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"

	is_done $FUNCNAME && return 0

	get "https://www.kernel.org/pub/linux/kernel/v3.x/$file"
	stage $file

	# build
	pushd "$SRC/$name-$version"
		make mrproper
		make ARCH=$ARCH headers_check
		make ARCH=$ARCH INSTALL_HDR_PATH="$SYSROOT/usr" headers_install

		touch "$PRG/$FUNCNAME.done"
	popd
}

uclibc() {
	local n="uClibc"
	local v="0.9.33.2"
	local e="tar.xz"
	is_done $FUNCNAME && return 0

	get "http://www.uclibc.org/downloads/$n-$v.$e"
	stage $n $v $e
	pushd "$SRC/$n-$v"
		cp $BOOTSTRAP/uclibc-$ARCH.config .config
		sed -i "s/XTARGETX/$TARGET/g" .config
		make install
		touch "$PRG/$FUNCNAME.done"
	popd

}

GLIBC_VERSION="2.20"

glibc_headers() {
	local name="glibc"
	local version="$GLIBC_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"
	local flags="\
		--host=$TARGET
		--build=$(../glibc-2.20/scripts/config.guess) \
		--disable-profile                             \
		--enable-kernel=2.6.32                        \
		--with-headers=$SYSROOT/usr/include                 \
		libc_cv_forced_unwind=yes                     \
		libc_cv_ctors_header=yes                      \
		libc_cv_c_cleanup=yes"

	is_done $FUNCNAME && return 0
	get "$GNU_MIRROR/$name/$file"
	stage $file

	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure $COMMON_FLAGS $flags
		make
		#touch "$PRG/$FUNCNAME.done"
	popd

}

_glibc_headers() {
	export MAKEFLAGS="-j4 -s -w"
	local n="eglibc"
	local v="2.13"
	local r="r13356"
	local e="tar.bz2"
	local f="$n-$v-$r.$e"

	local flags="--prefix=/usr \
		--host=$TARGET \
		--with-headers=$SYSROOT/usr/include \
		--disable-profile \
		--without-gd \
		--without-cvs \
		--enable-add-ons \
		--enable-kernel=2.6.39"

	is_done $FUNCNAME && return 0

	local mirror="http://ftp.cross-lfs.org/pub/clfs/clfs-packages/1.2.0"
	get "$mirror/$f"
	get "$mirror/eglibc-ports-2.13-r13356.tar.bz2"
	get "$mirror/eglibc-2.13-r13356-dl_dep_fix-1.patch"

	if [[ ! -d $SRC/$n-$v ]]; then
		stage $n $v-$r $e
		stage $n-ports $v-$r  $e
		cp -a "$SRC/ports" "$SRC/$n-$v/ports"
		pushd "$SRC/eglibc-$v"
			patch -p1 -i "$TAR/eglibc-2.13-r13356-dl_dep_fix-1.patch"
		popd
	fi

	mk_build_dir $FUNCNAME
	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$n-$v/configure" $COMMON_FLAGS $flags
		make install-headers install_root="$SYSROOT" install-bootstrap-headers=yes

		make csu/subdir_lib
		mkdir -p $SYSROOT/usr/lib
		cp csu/crt1.o csu/crti.o csu/crtn.o $SYSROOT/usr/lib

		$TARGET-gcc -nostdlib -nostartfiles -shared -x c /dev/null \
			-o "$SYSROOT/usr/lib/libc.so"

		touch "$PRG/$FUNCNAME.done"
	popd

}

stage2_gcc() {
	local n="gcc"
	local v="4.7.3"
	local e="tar.bz2"
	local flags="--disable-libssp \
		--disable-libquadmath \
		--disable-libmudflap \
		--with-gmp=$PREFIX \
		--disable-libgomp \
		--enable-languages=c" 

	is_done $FUNCNAME && return 0

	stage $n $v $e 
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$n-$v/configure" $COMMON_FLAGS $flags
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

final_glibc() {
	local n="eglibc"
	local v="2.13"
	local r="r13356"
	local e="tar.bz2"
	local flags="--prefix=/usr \
		--host=$TARGET \
		--with-headers=$SYSROOT/usr/include \
		--disable-profile \
		--without-gd \
		--without-cvs \
		--enable-add-ons \
		--enable-kernel=2.6.39"

	is_done $FUNCNAME && return 0

	if [[ ! -d $SRC/$n-$v ]]; then
		stage $n $v-$r $e
		stage $n-ports $v-$r  $e
		cp -a "$SRC/ports" "$SRC/$n-$v/ports"
	fi

	mk_build_dir $FUNCNAME
	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$n-$v/configure" $COMMON_FLAGS $flags
		make all
		make install install_root=$SYSROOT
		touch "$PRG/$FUNCNAME.done"
	popd

}

final_gcc() {
	local n="gcc"
	local v="4.7.3"
	local e="tar.bz2"
	local f="--disable-libssp \
		--disable-libgomp \
		--disable-libmudflap \
		--disable-libquadmath \
		--with-gmp=$PREFIX \
		--enable-static \
		--enable-languages=c"

	is_done $FUNCNAME && return 0

	stage $n $v $e 
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$n-$v/configure" $COMMON_FLAGS $f
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

for i in $SRC $BLD $TAR $PRG; do
	if [[ ! -d $i ]]; then 
		mkdir -p -v $i
	fi
done

#cross_sed
#cross_make
#native_compiler
cross_binutils
cross_gmp
cross_mpfr
cross_mpc
cross_gcc
linux_headers
glibc_headers

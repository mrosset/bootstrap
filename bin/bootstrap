#!/bin/bash


set -ehu

xpwd=$PWD
user=$USER
term=$TERM
home=$HOME

unset $(env | awk -F= '/^\w/ {print $1}' | xargs)



# enviroment
export HOME=$home
export PWD=$xpwd
export USER=$user
export TERM=$term
export LC_ALL="POSIX"

BOOTSTRAP="$PWD"

# check we are in the right directory
if [[ ! -f $BOOTSTRAP/bin/bootstrap ]]; then
	echo This needs to be run in boostrap directory eg. bin/bootstrap
	exit 1
fi

# toolchain tweaks
export CFLAGS="-O2 -pipe"
export CPPFLAGS="$CFLAGS"
export MAKEFLAGS="-sw"
export LIBTOOLFLAGS="--silent"

LFS_TGT="x86_64-lfs-linux-gnu"
#TARGET="arm-unknown-linux-gnueabi"
#TARGET="i686-linux-gnu"
LFS="/mnt/lfs"
PREFIX="/tools"

export PATH=$HOME/bin:$PREFIX/bin:/bin:/usr/bin

case $LFS_TGT in
	arm*-*)
		ARCH=arm
		MFLAGS=""
		#MFLAGS="--with-march=armv7"
		;;
	x86_64-*)
		ARCH=x86_64
		MFLAGS=""
		;;
	i686-*)
		ARCH=i386
		MFLAGS=""
		;;
	*)
		echo "$TARGET:" unknown arch
		exit 1
		;;
esac

# Dirs
SRC="$BOOTSTRAP/src"
BLD="$BOOTSTRAP/bld"
TAR="$BOOTSTRAP/tar"
PRG="$BOOTSTRAP/prg"

COMMON_FLAGS="--prefix=$PREFIX --disable-bootstrap --config-cache -q"

# Mirrors
GNU_MIRROR="http://mirrors.kernel.org/gnu"


lfs_chroot() {
	sudo chroot "$LFS" $PREFIX/bin/env -i \
		HOME=$HOME                  \
		TERM="$TERM"                \
		PS1='\u:\w\$ '              \
		PATH=/bin:/usr/bin:/sbin:/usr/sbin:$PREFIX/bin:$PREFIX/usr/bin \
		$PREFIX/bin/bash --login +h
	exit 0
}

is_done() {
	if [[ -f $PRG/$1.done ]]; then
		echo "$1 done skipping."
		return 0;
	else
		return 1;
	fi
}

mk_build_dir() {
	[[ -d $BLD/$1 ]] && return 0
	mkdir -p "$BLD/$1"
}

stage() {
	local dir="${file%.*.*}"
	[[ -d $SRC/$dir ]] && return 0 
	echo "staging $1"
	tar xf "$TAR/$1" -C "$SRC"
	return 0
}

get() {
	[[ -f $TAR/$(/usr/bin/basename $1) ]] && return 0
	pushd "$TAR"
		/usr/bin/wget -c "$1"
	popd
}

SED_VERSION="4.2.2"

cross_sed() {
	local name="sed"
	local ver="$SED_VERSION"
	local ext="tar.bz2"
	local file="$name-$ver.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure --prefix=$PREFIX -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

cross_texinfo() {
	local n="texinfo"
	local v="4.13a"
	local e="tar.gz"
	local f="$n-$v.$e"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$n/$f"
	stage $n $v $e
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$n-4.13/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

native_compiler() {
	local upstream="http://landley.net/aboriginal/downloads/binaries/root-filesystem/native-compiler-x86_64.tar.bz2"
	local file="$(/usr/bin/basename $upstream)"

	is_done $FUNCNAME && return 0

	get $upstream
	stage $file
	mv "$SRC/${file%.*.*}" .
	touch "$PRG/$FUNCNAME.done"
	#get $upstream
}


MAKE_VERSION="3.82"

cross_make() {
	local name="make"
	local ver="$MAKE_VERSION"
	local ext="tar.gz"
	local file="$name-$ver.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

BINUTILS_VERSION="2.24"

stage1_binutils() {
	local name="binutils"
	local ver="$BINUTILS_VERSION"
	local file="$name-$ver.tar.bz2"
	local flags="\
		--with-sysroot=$LFS        \
		--with-lib-path=/tools/lib \
		--target=$LFS_TGT          \
		--disable-nls              \
		--disable-werror"
	
	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage "$file"
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure $COMMON_FLAGS $flags
		make configure-host
		make
		make install
		mkdir -v $PREFIX/lib && ln -sv lib $PREFIX/lib64
		touch "$PRG/$FUNCNAME.done"
	popd
}

MPC_VERSION="1.0.2"

stage2_mpc() {
	local name="mpc"
	local version="$MPC_VERSION"
	local ext="tar.gz"
	local file="$name-$version.$ext"
	local flags="--with-gmp=$PREFIX"
	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure --prefix=$PREFIX $flags -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

MPFR_VERSION="3.1.2"

stage2_mpfr() {
	local name="mpfr"
	local version="$MPFR_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"
	local flags="--with-gmp=$PREFIX"
	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure --prefix=$PREFIX $flags -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

GMP_VERSION="6.0.0a"

stage2_gmp() {
	local name="gmp"
	local version="$GMP_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-6.0.0/configure --prefix=$PREFIX -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

GCC_VERSION="4.9.2"

stage1_gcc() {
	local name="gcc"
	local version="$GCC_VERSION"
	local ext="tar.bz2"
	local file="$name-$version.$ext"

	local flags="\
		--target=$LFS_TGT                                \
		--with-sysroot=$LFS                              \
		--with-newlib                                    \
		--without-headers                                \
		--with-local-prefix=$PREFIX                      \
		--with-native-system-header-dir=$PREFIX/include  \
		--disable-nls                                    \
		--disable-shared                                 \
		--disable-multilib                               \
		--disable-decimal-float                          \
		--disable-threads                                \
		--disable-libatomic                              \
		--disable-libgomp                                \
		--disable-libitm                                 \
		--disable-libquadmath                            \
		--disable-libsanitizer                           \
		--disable-libssp                                 \
		--disable-libvtv                                 \
		--disable-libcilkrts                             \
		--disable-libstdc++-v3                           \
		--enable-languages=c,c++"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$name-$version/$file"
	stage $file
	mk_build_dir $FUNCNAME

	pushd "$SRC/$name-$version"
	if [[ ! -f $PRG/${FUNCNAME}_patch ]]; then
		sed -i '/k prot/agcc_cv_libc_provides_ssp=yes' gcc/configure
		for file in \
			$(find gcc/config -name linux64.h -o -name linux.h -o -name sysv4.h)
	do
		cp -uv $file{,.orig}
		sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g' \
			-e 's@/usr@/tools@g' $file.orig > $file
		echo '
		#undef STANDARD_STARTFILE_PREFIX_1
		#undef STANDARD_STARTFILE_PREFIX_2
		#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"
		#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file
		touch $file.orig
	done
	touch "$PRG/${FUNCNAME}_patch.done"
	fi
	popd

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure $COMMON_FLAGS $flags
		make all
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

LINUX_VERSION="3.17.2"

linux_headers() {
	local name="linux"
	local version="$LINUX_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"

	is_done $FUNCNAME && return 0

	get "https://www.kernel.org/pub/linux/kernel/v3.x/$file"
	stage $file

	# build
	pushd "$SRC/$name-$version"
		make mrproper
		make ARCH=$ARCH headers_check
		make ARCH=$ARCH INSTALL_HDR_PATH="$PREFIX" headers_install
		touch "$PRG/$FUNCNAME.done"
	popd
}

GLIBC_VERSION="2.20"

stage1_glibc() {
	local name="glibc"
	local version="$GLIBC_VERSION"
	local ext="tar.xz"
	local file="$name-$version.$ext"
	local flags="\
		--host=$LFS_TGT                                 \
		--build=$($SRC/glibc-2.20/scripts/config.guess) \
		--disable-profile                               \
		--enable-kernel=2.6.32                          \
		--with-headers=$PREFIX/include                  \
		libc_cv_forced_unwind=yes                       \
		libc_cv_ctors_header=yes                        \
		libc_cv_c_cleanup=yes"

	is_done $FUNCNAME && return 0
	get "$GNU_MIRROR/$name/$file"
	stage $file

	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/configure $COMMON_FLAGS $flags
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd

}

stage1_libstdc++() {
	local name="gcc"
	local version="$GCC_VERSION"
	local flags="\
		--host=$LFS_TGT                 \
		--disable-multilib              \
		--disable-shared                \
		--disable-nls                   \
		--disable-libstdcxx-threads     \
		--disable-libstdcxx-pch         \
		--with-gxx-include-dir=$PREFIX/$LFS_TGT/include/c++/$version"

	is_done $FUNCNAME && return 0
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$version/libstdc++-v3/configure $COMMON_FLAGS $flags
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd

}

test_gcc() {
	echo 'main(){ return 0; }' > dummy.c
	$LFS_TGT-gcc dummy.c
	readelf -l a.out | grep ": $PREFIX"
	./a.out
	echo stage1 gcc ok
	return 0
}

stage2_binutils() {
	local name="binutils"
	local version="$BINUTILS_VERSION"
	local flags="\
		CC=$LFS_TGT-gcc                \
		AR=$LFS_TGT-ar                 \
		RANLIB=$LFS_TGT-ranlib         \
		--disable-nls                  \
		--disable-werror               \
		--with-lib-path=$PREFIX/lib    \
		--with-sysroot"

	is_done $FUNCNAME && return 0
	mk_build_dir $FUNCNAME

	pushd "$BLD/$FUNCNAME"
		"$SRC/$name-$version/configure" $COMMON_FLAGS $flags
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

stage2_gcc() {
	local name="gcc"
	local version="$GCC_VERSION"
	local flags="\
		CC=$LFS_TGT-gcc                                  \
		CXX=$LFS_TGT-g++                                 \
		AR=$LFS_TGT-ar                                   \
		RANLIB=$LFS_TGT-ranlib                           \
		--with-local-prefix=$PREFIX                      \
		--with-native-system-header-dir=$PREFIX/include  \
		--enable-languages=c,c++                         \
		--disable-libstdcxx-pch                          \
		--disable-multilib                               \
		--disable-bootstrap                              \
		--disable-libgomp"

	is_done $FUNCNAME && return 0

	mk_build_dir $FUNCNAME

	pushd "$SRC/$name-$version"
		cat gcc/limitx.h gcc/glimits.h gcc/limity.h > \
			`dirname $($LFS_TGT-gcc -print-libgcc-file-name)`/include-fixed/limits.h
	popd

	# build
	pushd "$BLD/$FUNCNAME"
		"$SRC/$name-$version/configure" $COMMON_FLAGS $flags
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

BASH_VERSION="4.3"

tools_bash() {
	local name="bash"
	local ver="$BASH_VERSION"
	local ext="tar.gz"
	local file="$name-$ver.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure $COMMON_FLAGS --prefix=$PREFIX -q
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}

tools_toybox() {
	file="toybox-$ARCH"
	get "http://landley.net/toybox/bin/$file"
	install -d "$PREFIX/usr/bin"
	install -d "$PREFIX/usr/sbin"
	install $TAR/$file $PREFIX/bin/toybox
	for i in $($PREFIX/bin/toybox --long); do 
		ln -sfv "$PREFIX/bin/toybox" "$PREFIX/$i"
	done
	touch "$PRG/$FUNCNAME.done"
}

COREUTILS_VERSION="8.23"

tools_coreutils() {
	local name="coreutils"
	local ver="$COREUTILS_VERSION"
	local ext="tar.xz"
	local file="$name-$ver.$ext"

	is_done $FUNCNAME && return 0

	get "$GNU_MIRROR/$name/$file"
	stage $file
	mk_build_dir $FUNCNAME

	# build
	pushd "$BLD/$FUNCNAME"
		$SRC/$name-$ver/configure $COMMON_FLAGS
		make
		make install
		touch "$PRG/$FUNCNAME.done"
	popd
}
for i in $SRC $BLD $TAR $PRG; do
	if [[ ! -d $i ]]; then 
		mkdir -p -v $i
	fi
done

if [[ $1 == chroot ]]; then
	lfs_chroot
	exit 0
fi

if [[ $1 == build ]]; then
	#cross_sed
	#cross_make
	#native_compiler
	stage1_binutils
	stage1_gcc
	linux_headers
	stage1_glibc
	test_gcc
	stage1_libstdc++
	stage2_binutils
	stage2_gmp
	stage2_mpfr
	stage2_mpc
	stage2_gcc
	test_gcc
	tools_bash
	tools_coreutils
fi
